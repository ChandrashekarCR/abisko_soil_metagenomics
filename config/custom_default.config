// Custom Nextflow configuration for nf-core/mag pipeline
// Optimized for paired short reads with taxonomy classification

// 
// PIPELINE PARAMETERS
// 

params {
    // Profile metadata
    config_profile_name        = 'Abisko Soil Metagenomics - Config File'
    config_profile_description = 'This setup is optimized for 250 CPUs and 2TB RAM system with nf-core config settings'

    // Input and output directories
    input       = '/home/inf-21-2024/nbis/samplesheet/kj_samplesheet.csv'
    outdir      = '/home/inf-21-2024/nbis/results'
    
    //  Input Configuration 
    single_end = false
    coassemble_group = false  // Individual assembly per sample
    
    //  QC for Short Reads Only 
    clip_tool = 'fastp'
    reads_minlength = 50
    fastp_qualified_quality = 25
    fastp_cut_mean_quality = 25
    skip_longread_qc = true
    skip_adapter_trimming = false  // Changed to false
    skip_longread_filtering = true
    
    //  We use only megahit for assembly with custom soil metagenome parameters
    skip_spades = true
    skip_spadeshybrid = true
    skip_megahit = false
    skip_metamdbg = true
    skip_flye = true
    megahit_options = '--presets meta-sensitive --k-min 21 --k-max 161 --k-step 12 --min-count 2 --prune-level 3'
    megahit_fix_cpu_1 = false
    
    //  Gene Prediction: Prodigal Only 
    skip_prodigal = false
    skip_prokka = true
    skip_metaeuk = true
    
    //  Virus Identification: Skip 
    run_virus_identification = false
    
    //  Binning: MetaBAT2 + MaxBin2 + CONCOCT with DAS Tool Refinement 
    skip_binning = false
    skip_metabat2 = false
    skip_maxbin2 = false
    skip_concoct = false
    binning_map_mode = 'group'
    min_contig_size = 2500
    bin_min_size = 0  
    refine_bins_dastool = true
    refine_bins_dastool_threshold = 0.3
    postbinning_input = 'both'
    
    //  Bin Quality Check: BUSCO 
    skip_binqc = false
    binqc_tool = 'busco'
    busco_db_lineage = 'auto'
    busco_clean = true
    save_busco_db = true
    
    //  Taxonomic Classification: GTDB-Tk with Local Database 
    skip_gtdbtk = false
    gtdb_db = '/home/inf-21-2024/nbis/databases/gtdb-tk/gtdbtk_r220_data'
    gtdbtk_min_completeness = 10  // Lowered from 20
    gtdbtk_max_contamination = 50  // Increased from 30
    gtdbtk_min_perc_aa = 10
    gtdbtk_min_af = 0.65
    gtdbtk_pplacer_cpus = 32
    gtdbtk_pplacer_useram = true
    
    //  Ancient DNA: Skip 
    ancient_dna = false
    skip_ancient_damagecorrection = true
    
    //  Resource Configuration 
    max_cpus = 250
    max_memory = '2000.GB'
    max_time = '240.h'
    
    //  Additional Settings 
    multiqc_title = 'Abisko Soil Metagenomics - nf-core/mag'
}


// CONTAINER CONFIGURATION

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = '/home/inf-21-2024/nbis/.singularity_cache'
    runOptions = '--bind /home/inf-21-2024/nbis/databases:/home/inf-21-2024/nbis/databases'
}

// Process resource configuration
process {
    
    // Default resources for all processes with generous allocations
    cpus = 8
    memory = 32.GB
    time = 12.h
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2
    
    // QC & PREPROCESSING
    withName: 'NFCORE_MAG:MAG:SHORTREAD_PREPROCESSING:FASTQC_RAW' {
        cpus = 8; memory = 16.GB; time = 4.h
    }
    
    withName: 'NFCORE_MAG:MAG:SHORTREAD_PREPROCESSING:FASTP' {
        cpus = 16; memory = 64.GB; time = 8.h
        errorStrategy = 'retry'
        maxRetries = 2
    }

    withName: 'NFCORE_MAG:MAG:SHORTREAD_PREPROCESSING:BOWTIE2_PHIX_REMOVAL_BUILD' {
        cpus = 16; memory = 32.GB; time = 2.h
    }

    withName: 'NFCORE_MAG:MAG:SHORTREAD_PREPROCESSING:BOWTIE2_PHIX_REMOVAL_ALIGN' {
        cpus = 32
        memory = 128.GB
        time = 48.h
        errorStrategy = 'retry'
        maxRetries = 4
    }

    withName: 'NFCORE_MAG:MAG:SHORTREAD_PREPROCESSING:FASTQC_TRIMMED' {
        cpus = 8; memory = 16.GB; time = 4.h
    }

    // ASSEMBLY
    withName: 'NFCORE_MAG:MAG:ASSEMBLY:SHORTREAD_ASSEMBLY:MEGAHIT' {
        cpus = 120; memory = 600.GB; time = 96.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:ASSEMBLY:GUNZIP_SHORTREAD_ASSEMBLIES' {
        cpus = 8; memory = 16.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:QUAST' {
        cpus = 16; memory = 32.GB; time = 4.h
    }

    // GENE PREDICTION
    withName: 'NFCORE_MAG:MAG:PRODIGAL' {
        cpus = 24; memory = 96.GB; time = 72.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    // BINNING PREPARATION
    withName: 'NFCORE_MAG:MAG:BINNING_PREPARATION:SHORTREAD_BINNING_PREPARATION:BOWTIE2_ASSEMBLY_BUILD' {
        cpus = 16; memory = 64.GB; time = 8.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING_PREPARATION:SHORTREAD_BINNING_PREPARATION:BOWTIE2_ASSEMBLY_ALIGN' {
        cpus = 64; memory = 192.GB; time = 48.h
        errorStrategy = 'retry'
        maxRetries = 2
    }

    // BINNING
    withName: 'NFCORE_MAG:MAG:BINNING:METABAT2_JGISUMMARIZEBAMCONTIGDEPTHS_SHORTREAD' {
        cpus = 16; memory = 64.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:CONVERT_DEPTHS' {
        cpus = 8; memory = 32.GB; time = 2.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:METABAT2_METABAT2' {
        cpus = 32; memory = 128.GB; time = 24.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:BINNING:MAXBIN2' {
        cpus = 128
        memory = 512.GB
        time = 72.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:BINNING:CONCOCT_CONCOCT' {
        cpus = 48
        memory = 256.GB
        time = 48.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:BINNING:CONCOCT_CUTUPFASTA' {
        cpus = 16
        memory = 64.GB
        time = 8.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:CONCOCT_CONCOCTCOVERAGETABLE' {
        cpus = 32
        memory = 128.GB
        time = 16.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:BINNING:CONCOCT_MERGECUTTUPCONTIGCLUSTERING' {
        cpus = 8
        memory = 32.GB
        time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:ADJUST_MAXBIN2_EXT' {
        cpus = 4; memory = 16.GB; time = 2.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:SEQKIT_STATS' {
        cpus = 8; memory = 16.GB; time = 2.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:SPLIT_FASTA' {
        cpus = 8; memory = 32.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING:GUNZIP_BINS' {
        cpus = 4; memory = 8.GB; time = 2.h
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:RENAME_PREDASTOOL' {
        cpus = 4; memory = 8.GB; time = 1.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:DASTOOL_FASTATOCONTIG2BIN_METABAT2' {
        cpus = 8; memory = 16.GB; time = 2.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:DASTOOL_FASTATOCONTIG2BIN_MAXBIN2' {
        cpus = 8; memory = 16.GB; time = 2.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:DASTOOL_FASTATOCONTIG2BIN_CONCOCT' {
        cpus = 8
        memory = 16.GB
        time = 2.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:DASTOOL_DASTOOL' {
        cpus = 48
        memory = 128.GB
        time = 24.h
        errorStrategy = 'ignore'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:BINNING_REFINEMENT:RENAME_POSTDASTOOL' {
        cpus = 4; memory = 8.GB; time = 1.h
        errorStrategy = 'ignore'
    }

    // DEPTH ANALYSIS
    withName: 'NFCORE_MAG:MAG:DEPTHS:MAG_DEPTHS' {
        cpus = 16; memory = 32.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:DEPTHS:MAG_DEPTHS_PLOT' {
        cpus = 8; memory = 16.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:DEPTHS:MAG_DEPTHS_SUMMARY' {
        cpus = 8; memory = 16.GB; time = 4.h
    }

    // BIN QUALITY 
    withName: 'NFCORE_MAG:MAG:BIN_QC:BUSCO_BUSCO' {
        cpus = 24; memory = 96.GB; time = 24.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BIN_QC:CONCAT_BINQC_TSV' {
        cpus = 4; memory = 8.GB; time = 2.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:QUAST_BINS' {
        cpus = 16; memory = 32.GB; time = 4.h
    }

    withName: 'NFCORE_MAG:MAG:QUAST_BINS_SUMMARY' {
        cpus = 8; memory = 16.GB; time = 2.h
    }

    // TAXONOMIC CLASSIFICATION

    withName: 'NFCORE_MAG:MAG:GTDBTK:GTDBTK_CLASSIFYWF' {
        cpus = 80; memory = 480.GB; time = 48.h
        errorStrategy = 'retry'
        maxRetries = 1
    }

    withName: 'NFCORE_MAG:MAG:GTDBTK:GTDBTK_SUMMARY' {
        cpus = 8; memory = 16.GB; time = 2.h
        errorStrategy = 'ignore'
    }

    withName: 'NFCORE_MAG:MAG:BIN_SUMMARY (1)' {
        cpus = 8; memory = 16.GB; time = 2.h
        errorStrategy = 'ignore'
    }

    // MULTIQC
    withName: 'NFCORE_MAG:MAG:MULTIQC' {
        cpus = 8; memory = 32.GB; time = 4.h
        errorStrategy = 'ignore'
    }


}

// Executor configuration
executor {
    name = 'local'
    cpus = 250
    memory = '2000 GB'
    queueSize = 40
}

// Pipeline reporting
timeline {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    overwrite = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}