// Custom Nextflow configuration for nf-core/mag pipeline
// Optimized for paired short reads with taxonomy classification

// ================================================================================
// PIPELINE PARAMETERS
// ================================================================================

params {
    // Profile metadata
    config_profile_name        = 'Abisko Soil Metagenomics - Default Config'
    config_profile_description = 'Optimized for 250 CPUs and 2TB RAM system with default nf-core configs'

    // Input and output directories
    input       = '/home/inf-21-2024/nbis/data/short_test_data.csv'
    outdir      = '/home/inf-21-2024/nbis/results'
    
    // ===== Input Configuration =====
    single_end = false
    
    // ===== QC for Short Reads Only =====
    clip_tool = 'fastp'
    reads_minlength = 15
    fastp_qualified_quality = 15
    fastp_cut_mean_quality = 15
    skip_longread_qc = true
    skip_adapter_trimming = true
    skip_longread_filtering = true
    
    // ===== Assembly: Co-assembly by Group with MEGAHIT Only =====
    coassemble_group = true
    skip_spades = true
    skip_spadeshybrid = true
    skip_megahit = false
    skip_metamdbg = true
    skip_flye = true
    megahit_options = '--k-min 21 --k-max 141 --k-step 12 --min-count 2'
    megahit_fix_cpu_1 = false
    
    // ===== Gene Prediction: Prodigal Only =====
    skip_prodigal = false
    skip_prokka = true
    skip_metaeuk = true
    
    // ===== Virus Identification: Skip =====
    run_virus_identification = false
    
    // ===== Binning: MetaBAT2 + MaxBin2 with DAS Tool Refinement =====
    skip_binning = false
    skip_metabat2 = false
    skip_maxbin2 = false
    skip_concoct = true
    binning_map_mode = 'group'
    min_contig_size = 1500
    refine_bins_dastool = true
    refine_bins_dastool_threshold = 0.5
    postbinning_input = 'refined_bins_only'
    
    // ===== Bin Quality Check: BUSCO =====
    skip_binqc = false
    binqc_tool = 'busco'
    //busco_db = '/home/inf-21-2024/nbis/databases/busco_db'
    busco_db_lineage = 'auto'
    busco_clean = true
    save_busco_db = true
    
    // ===== Taxonomic Classification: GTDB-Tk with Local Database =====
    skip_gtdbtk = false
    gtdb_db = '/home/inf-21-2024/nbis/databases/gtdb-tk/gtdbtk_r220_data'
    gtdbtk_min_completeness = 20 //50
    gtdbtk_max_contamination = 25 //10
    gtdbtk_min_perc_aa = 5 //10
    gtdbtk_min_af = 0.5 //0.65
    gtdbtk_pplacer_cpus = 32
    gtdbtk_pplacer_useram = true
    
    // ===== Ancient DNA: Skip =====
    ancient_dna = false
    skip_ancient_damagecorrection = true
    
    // ===== Resource Configuration =====
    max_cpus = 250
    max_memory = '2000.GB'
    max_time = '240.h'
    
    // ===== Additional Settings =====
    multiqc_title = 'Abisko Soil Metagenomics - nf-core/mag'
}

// ================================================================================
// CONTAINER CONFIGURATION
// ================================================================================

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = '/home/inf-21-2024/nbis/.singularity_cache'
    runOptions = '--bind /home/inf-21-2024/nbis/databases:/databases'
}

// Process resource configuration
process {
    
    // Default resources for all processes
    cpus = 8
    memory = 32.GB
    time = 6.h
    
    // ===== ASSEMBLY =====
    withName: '.*MEGAHIT.*' {
        cpus = 128
        memory = 600.GB
        time = 72.h
    }
    
    // ===== BINNING =====
    withName: '.*METABAT2.*' {
        cpus = 32
        memory = 200.GB
        time = 24.h
    }
    
    withName: '.*MAXBIN2.*' {
        cpus = 32
        memory = 200.GB
        time = 24.h
    }
    
    
    // ===== BINNING REFINEMENT =====
    withName: '.*DASTOOL.*' {
        cpus = 32
        memory = 150.GB
        time = 24.h
    }
    
    // ===== BIN QUALITY CONTROL =====
    withName: '.*BUSCO.*' {
        cpus = 32
        memory = 100.GB
        time = 48.h
    }
    
    
    // ===== TAXONOMY =====
    withName: '.*GTDBTK.*' {
        cpus = 64
        memory = 400.GB
        time = 72.h
    }
    
    // ===== GENE PREDICTION =====
    withName: '.*PRODIGAL.*' {
        cpus = 16
        memory = 50.GB
        time = 12.h
    }

    
    // ===== MAPPING =====
    withName: '.*BOWTIE2.*ALIGN.*' {
        cpus = 32
        memory = 100.GB
        time = 24.h
    }
    
    withName: '.*MINIMAP2.*' {
        cpus = 32
        memory = 100.GB
        time = 24.h
    }
    
    // ===== QC =====
    withName: '.*FASTQC.*' {
        cpus = 8
        memory = 32.GB
        time = 4.h
    }
    
    withName: '.*FASTP.*' {
        cpus = 32
        memory = 64.GB
        time = 8.h
    }
    
    withName: '.*QUAST.*' {
        cpus = 8
        memory = 32.GB
        time = 6.h
    }
    
    withName: '.*MULTIQC.*' {
        cpus = 4
        memory = 16.GB
        time = 2.h
    }
}

// Executor configuration
executor {
    name = 'local'
    cpus = 250
    memory = '2000 GB'
    queueSize = 40  // Run up to 20 processes in parallel
}

// Pipeline reporting
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
}